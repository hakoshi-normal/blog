---
title: 麻雀放送対局用のオートスイッチャーを作りたい
# publishdate: 2023-12-01
date: 2024-02-10
tags: [Python, OpenCV, MediaPipe, 麻雀自動採譜]
toc: true
---

## はじめに

<a href="/blog/tags/麻雀自動採譜/" target="_blank" rel="noopener noreferrer">自動採譜プロジェクト</a>の息抜き的な記事です．

せっかく全自動雀卓があって，手元用カメラが4台あるんだから，麻雀の配信とか出来たら嬉しいよね～とか言う話の流れになりまして，
ところが同卓者を募るので精一杯な状況で配信スタッフをおくわけにもいかない．だったらカメラの切り替えぐらいは自動化しちゃおう！！ってのがこの記事の主旨です．

## カメラ切り替えトリガー

カメラの切り替えトリガーを「**牌山にプレーヤーが触れたタイミング**」と設定しました．

自動採譜プロジェクトの実装作業も視野に入れて，手牌変化を監視する手法も無くはないです．ただし，牌検出に計算コストがかかること，カメラ切り替えが牌検出精度に依存してしまうことを考慮し，今回はよりシンプルな方法を選択しました．

## ツモ位置の検出

まず，天カメの映像から卓上のツモ位置を特定する必要があります．<br>牌山の形を見てみましょう．

対局開始前はこんな感じ．

{{< figure src="t_0.png" class="center">}}

対局開始直後はこんな感じ．

{{< figure src="t_1.png" class="center">}}

対局中はこんな感じ．

{{< figure src="t_2.png" class="center">}}

対局開始前は4つ牌山がありますが，対局開始以降は牌山が~~必ず3つ以下になります~~王牌の扱い上，4つのときもあります．

- 牌山が3つのとき
    
    牌山の並びを時計回りに見た際に，牌山が何もない場合は隣の牌山の端点がツモ位置になります．

- 牌山が4つのとき

    一つの家に2つ矩形が検出された場合，それを王牌と判定し，ツモ位置を特定します．

{{< figure src="fig1.png" class="center">}}

実装の流れとしては，麻雀牌背面色部分を天カメ映像から取得し，そこから矩形を検出しています．手牌や河などから発生する検出ミスは矩形領域の面積や画素成分などで例外処理をしています．

牌山検出後，卓全体をXの字に4分割し，矩形の重心位置に基づき分類しています．

### 実装概要

元画像です．読み込み時に卓の形状に合わせてトリミングしておきます．リアルタイムの牌山検出を行う際はノイズ軽減のため，鳴き牌表示部分と卓中央部分は予めマスク処理を行っておきます．
{{< figure src="original_image.png" class="center">}}

`cv2.inRange()`を使用し，画像中の麻雀牌の背面色を絞り込みます．その際，クロージング処理を行いノイズの発生を抑制します．

{{< figure src="mask_hai.png" class="center">}}

二値化した画像に対し，`cv2.findContours()`を使用し，牌山となりうる矩形を検出します．

手牌や鳴き牌，不意に伏せた牌が矩形として検出されてしまうため，矩形の座標，矩形の最小サイズ，矩形内の画素成分などにより牌山を絞り込みます．
その後，特定した牌山の中心位置に基づきツモ牌の位置を特定します．

{{< figure src="tsumohai.png" class="center">}}

## ツモプレイヤーの検出

ツモ動作をしたプレイヤーをリアルタイムで監視するため，画像中から手指検出をおこない，人差し指の位置に基づきツモ動作を検出します．
<a href="https://developers.google.com/mediapipe/solutions/vision/hand_landmarker" target="_blank" rel="noopener noreferrer">MediaPipe</a>
のハンドトラッキングを使って，前節のツモ位置と人差し指が近づいたタイミングをツモとして判定します．
今回は処理負荷軽減のため，手指検出をツモ牌の周辺に限定して推論を行っています．

{{< figure src="tsumo1.png" class="center">}}

プレイヤーの識別には，手首の座標と中指付け根の座標から成る線分の角度を求め，角度を4分割して識別しました．

{{< figure src="tsumo2.png" class="center">}}

## オートスイッチャー実装！！！

OBSを使用して配信するため，カメラ切り替えには
<a href="https://github.com/Elektordi/obs-websocket-py/" target="_blank" rel="noopener noreferrer">obs-websocket-py</a>
を使用しました．こちらの
<a href="https://github.com/Elektordi/obs-websocket-py/blob/master/samples/switch_scenes.py" target="_blank" rel="noopener noreferrer">サンプル</a>
がそのまま動作して助かりました．

GUI実装にはHTML/JSでの記述が可能な
<a href="https://github.com/python-eel/Eel" target="_blank" rel="noopener noreferrer">Eel</a>
を使用しました．GUI設計ライブラリ毎の独自記法を覚える必要がないので，かなり重宝しています．

実際の動作の様子がこちら．

{{< video src="cam_switcher_test" >}}

現時点では鳴きには対応してないので，手動切替機能も実装しています．とはいえ鳴いた牌を監視すればたぶん容易に検出可能なので，追々実装したいですね．

あと，牌山をずらす行為についても実装上では判定の対象となっています．これは両手で牌山をずらした場合に例外としてカメラ切り替えを行わない設計にすればある程度は回避できる問題です．ただし，自身のツモ番に牌山をずらすのは問題ないので，とりあえず保留ですね．
